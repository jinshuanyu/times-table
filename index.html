<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯æ„›ä¹˜æ³•ç·´ç¿’ç¶²ç«™</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Tone.js å‡½å¼åº« -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    <style>
        /* è¨­ç½®å…¨åŸŸå­—é«” */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* å­¸ç¿’é é¢ï¼šæ»‘é¼ æ‡¸åœæ™‚é«˜äº®æ•ˆæœ */
        .highlight-row {
            background-color: #fef08a !important; /* bg-yellow-200 */
        }
        .highlight-col {
            background-color: #fef08a !important; /* bg-yellow-200 */
        }
        .highlight-cell {
            background-color: #fcd34d !important; /* bg-amber-300 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-100 to-blue-100 flex flex-col items-center justify-center p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div class="w-full max-w-4xl p-4 md:p-8">

        <!-- å°è¦½åˆ— -->
        <nav class="mb-8 p-4 bg-white rounded-2xl shadow-lg flex flex-wrap justify-center gap-4">
            <button id="learningBtn" class="px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105">
                ğŸ“š å­¸ç¿’ä¹˜æ³•
            </button>
            <button id="practiceBtn" class="px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105">
                ğŸ“ ç·´ç¿’æŒ‘æˆ°
            </button>
        </nav>

        <!-- å­¸ç¿’é é¢ -->
        <main id="learningPage" class="hidden text-center transform transition-transform duration-500 ease-out">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 mb-8 drop-shadow-md">
                ååä¹˜æ³•è¡¨ ğŸ’–
            </h1>
            <div class="overflow-x-auto">
                <table id="multiplicationTable" class="w-full bg-blue-50 border border-blue-200 rounded-xl shadow-lg text-sm sm:text-base md:text-lg">
                    <!-- è¡¨æ ¼å°‡ç”± JavaScript å¡«å…… -->
                </table>
            </div>
            <p class="mt-8 text-gray-600 text-lg">
                é€™å€‹è¡¨æ ¼å¯ä»¥å¹«åŠ©ä½ å¿«é€Ÿå­¸ç¿’ä¹˜æ³•ï¼
            </p>
        </main>

        <!-- ç·´ç¿’é é¢ -->
        <main id="practicePage" class="hidden text-center transform transition-transform duration-500 ease-out">
            <h1 id="practiceTitle" class="text-4xl md:text-5xl font-extrabold text-green-600 mb-6 drop-shadow-md">
                ä¹˜æ³•å¤§æŒ‘æˆ° ğŸŒŸ
            </h1>

            <!-- ä¹˜æ•¸é¸æ“‡å€å¡Š -->
            <div id="multiplierSelection" class="p-4">
                <div id="multiplierButtons" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 max-w-2xl mx-auto mb-6">
                    <!-- ä¹˜æ•¸æŒ‰éˆ•å°‡ç”± JavaScript å¡«å…… -->
                </div>
                <button id="startBtn" class="px-8 py-4 rounded-full text-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg bg-gray-300 text-gray-600 cursor-not-allowed">
                    é–‹å§‹ç·´ç¿’ï¼ğŸš€
                </button>
            </div>

            <!-- ç·´ç¿’é¡Œç›®å€å¡Š -->
            <div id="questionContainer" class="hidden p-4">
                <div class="text-2xl md:text-3xl font-bold text-gray-700 mb-2">
                    å¾—åˆ†: <span id="scoreDisplay" class="text-green-600">0</span> / 100
                </div>
                <div class="text-xl md:text-2xl text-gray-600 mb-6">
                    é¡Œç›® <span id="questionIndex">1</span> / 10
                </div>

                <div class="bg-yellow-100 p-6 rounded-3xl shadow-xl inline-block mb-6 transition-transform duration-300 transform scale-105">
                    <p id="questionText" class="text-5xl md:text-6xl font-extrabold text-yellow-800">
                        ?
                    </p>
                </div>

                <div id="optionsContainer" class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-4">
                    <!-- ç­”æ¡ˆæŒ‰éˆ•å°‡ç”± JavaScript ç”Ÿæˆ -->
                </div>

                <p id="feedbackMessage" class="text-2xl md:text-3xl font-bold mt-4 animate-bounce">
                </p>
            </div>

            <!-- çµæœé é¢å€å¡Š -->
            <div id="resultContainer" class="hidden p-4">
                <h1 class="text-4xl md:text-5xl font-extrabold text-teal-600 mb-6 drop-shadow-md">
                    ç·´ç¿’çµæŸï¼ğŸ‰
                </h1>
                <p class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">
                    ä½ çš„æœ€çµ‚å¾—åˆ†æ˜¯ï¼š
                </p>
                <p id="finalScore" class="text-5xl md:text-6xl font-extrabold text-teal-600 bg-teal-50 p-6 rounded-full inline-block shadow-lg animate-bounce mb-6">
                    0 åˆ†
                </p>

                <h2 class="text-3xl font-bold text-blue-600 mt-6 mb-4 drop-shadow-md">
                    é¡Œç›®å›é¡§
                </h2>
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto mx-auto max-w-xl">
                    <table class="min-w-full text-left text-lg">
                        <thead>
                            <tr class="bg-blue-100 text-blue-800">
                                <th class="py-2 px-3 border-b border-blue-200">é¡Œç›®</th>
                                <th class="py-2 px-3 border-b border-blue-200">ä½ çš„ç­”æ¡ˆ</th>
                                <th class="py-2 px-3 border-b border-blue-200">æ­£ç¢ºç­”æ¡ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- æ­·å²è¨˜éŒ„å°‡ç”± JavaScript ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex flex-col md:flex-row justify-center gap-4">
                    <button id="restartBtn" class="px-8 py-4 rounded-full text-2xl font-bold bg-orange-500 text-white hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        é‡æ–°é¸æ“‡ç·´ç¿’ ğŸ”„
                    </button>
                    <button id="playAgainBtn" class="px-8 py-4 rounded-full text-2xl font-bold bg-purple-500 text-white hover:bg-purple-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
                        å†ç©ä¸€æ¬¡ï¼âœ¨
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript é‚è¼¯ (æ”¾åœ¨ body çµå°¾ç¢ºä¿æ‰€æœ‰ HTML å…ƒç´ éƒ½å·²è¼‰å…¥) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- é é¢å…ƒç´ åƒè€ƒ ---
            const learningBtn = document.getElementById('learningBtn');
            const practiceBtn = document.getElementById('practiceBtn');
            const learningPage = document.getElementById('learningPage');
            const practicePage = document.getElementById('practicePage');
            const multiplicationTable = document.getElementById('multiplicationTable');
            
            // --- ç·´ç¿’é é¢å…ƒç´ åƒè€ƒ ---
            const multiplierSelection = document.getElementById('multiplierSelection');
            const startBtn = document.getElementById('startBtn');
            const questionContainer = document.getElementById('questionContainer');
            const optionsContainer = document.getElementById('optionsContainer');
            const resultContainer = document.getElementById('resultContainer');
            const finalScore = document.getElementById('finalScore');
            const restartBtn = document.getElementById('restartBtn');
            const playAgainBtn = document.getElementById('playAgainBtn');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const questionIndex = document.getElementById('questionIndex');
            const questionText = document.getElementById('questionText');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const historyTableBody = document.getElementById('historyTableBody');
            const practiceTitle = document.getElementById('practiceTitle');
            const multiplierButtonsContainer = document.getElementById('multiplierButtons');

            // --- å…¨åŸŸç‹€æ…‹è®Šæ•¸ ---
            let selectedMultiplier = null;
            let currentQuestionIndex = 0;
            let currentQuestion = null;
            let score = 0;
            let questionHistory = [];
            let isAnimating = false;
            let synth = null;

            // --- å‡½å¼ï¼šå¡«å……å­¸ç¿’é é¢ä¹˜æ³•è¡¨ ---
            function createMultiplicationTable() {
                let tableHtml = `<thead>
                    <tr class="bg-blue-200 text-blue-800">
                        <th class="py-1 px-1 border-b border-blue-200 font-bold">Ã—</th>`;
                for (let i = 1; i <= 10; i++) {
                    tableHtml += `<th class="py-1 px-1 border-b border-blue-200 font-bold" data-col="${i}">${i}</th>`;
                }
                tableHtml += `</tr></thead><tbody>`;
                for (let i = 1; i <= 10; i++) {
                    tableHtml += `<tr data-row="${i}" class="transition-colors duration-200">`;
                    tableHtml += `<td class="py-1 px-1 border-b border-blue-200 text-blue-700 font-bold bg-blue-100">${i}</td>`;
                    for (let j = 1; j <= 10; j++) {
                        tableHtml += `<td class="py-1 px-1 border-b border-blue-200 text-gray-700" data-row="${i}" data-col="${j}">${i * j}</td>`;
                    }
                    tableHtml += `</tr>`;
                }
                tableHtml += `</tbody>`;
                multiplicationTable.innerHTML = tableHtml;

                // è¨»å†Šé«˜äº®äº‹ä»¶
                const allCells = multiplicationTable.querySelectorAll('td, th');

                allCells.forEach(cell => {
                    cell.addEventListener('mouseover', () => {
                        const row = cell.dataset.row;
                        const col = cell.dataset.col;

                        if (row) {
                            multiplicationTable.querySelectorAll(`[data-row="${row}"]`).forEach(el => el.classList.add('highlight-row'));
                        }
                        if (col) {
                            multiplicationTable.querySelectorAll(`[data-col="${col}"]`).forEach(el => el.classList.add('highlight-col'));
                        }
                        if (row && col) {
                            cell.classList.add('highlight-cell');
                        }
                    });

                    cell.addEventListener('mouseout', () => {
                        const allRows = multiplicationTable.querySelectorAll('.highlight-row');
                        const allCols = multiplicationTable.querySelectorAll('.highlight-col');
                        const allCells = multiplicationTable.querySelectorAll('.highlight-cell');

                        allRows.forEach(el => el.classList.remove('highlight-row'));
                        allCols.forEach(el => el.classList.remove('highlight-col'));
                        allCells.forEach(el => el.classList.remove('highlight-cell'));
                    });
                });
            }

            // --- å‡½å¼ï¼šå¡«å……ç·´ç¿’é é¢æŒ‰éˆ• ---
            function createMultiplierButtons() {
                let buttonsHtml = `<button data-multiplier="all" class="col-span-full p-4 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md mb-3 bg-indigo-200 text-indigo-800 hover:bg-indigo-300">
                                    ğŸ² ç¶œåˆç·´ç¿’ (1~10)
                                </button>`;
                for (let i = 1; i <= 10; i++) {
                    buttonsHtml += `<button data-multiplier="${i}" class="p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-orange-200 text-orange-800 hover:bg-orange-300">${i}x</button>`;
                }
                multiplierButtonsContainer.innerHTML = buttonsHtml;
            }

            // --- å‡½å¼ï¼šåˆ‡æ›é é¢ ---
            function showPage(pageId) {
                learningPage.classList.add('hidden');
                practicePage.classList.add('hidden');
                document.getElementById(pageId).classList.remove('hidden');

                learningBtn.className = 'px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105 bg-purple-200 text-purple-800 hover:bg-purple-300';
                practiceBtn.className = 'px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105 bg-green-200 text-green-800 hover:bg-green-300';
                
                if (pageId === 'learningPage') {
                    learningBtn.classList.add('bg-purple-500', 'text-white', 'shadow-md');
                    learningBtn.classList.remove('bg-purple-200', 'text-purple-800', 'hover:bg-purple-300');
                } else {
                    practiceBtn.classList.add('bg-green-500', 'text-white', 'shadow-md');
                    practiceBtn.classList.remove('bg-green-200', 'text-green-800', 'hover:bg-green-300');
                }
            }
            
            // --- å‡½å¼ï¼šæ’­æ”¾éŸ³æ•ˆ ---
            function playSound(isCorrect) {
                if (!synth) {
                    synth = new Tone.Synth().toDestination();
                }
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }

                if (isCorrect) {
                    synth.triggerAttackRelease("C5", "8n");
                    setTimeout(() => synth.triggerAttackRelease("G5", "8n"), 100);
                    setTimeout(() => synth.triggerAttackRelease("C5", "8n"), 300);
                    setTimeout(() => synth.triggerAttackRelease("G5", "8n"), 400);
                } else {
                    synth.triggerAttackRelease("F4", "8n");
                    setTimeout(() => synth.triggerAttackRelease("C4", "8n"), 250);
                }
            }
            
            // --- å‡½å¼ï¼šç”Ÿæˆé¡Œç›®å’Œé¸é … ---
            function generateQuestion() {
                let factor1, factor2;

                if (selectedMultiplier === 'all') {
                    factor1 = Math.floor(Math.random() * 10) + 1;
                    factor2 = Math.floor(Math.random() * 10) + 1;
                } else {
                    factor1 = parseInt(selectedMultiplier);
                    factor2 = Math.floor(Math.random() * 10) + 1;
                }

                const answer = factor1 * factor2;
                const newOptions = new Set();
                newOptions.add(answer);

                while (newOptions.size < 4) {
                    let wrongAnswer = answer + (Math.floor(Math.random() * 20) - 10);
                    if (wrongAnswer > 0 && wrongAnswer !== answer) {
                        newOptions.add(wrongAnswer);
                    }
                }

                const shuffledOptions = Array.from(newOptions).sort(() => Math.random() - 0.5);
                currentQuestion = { factor1, factor2, answer };

                questionText.textContent = `${factor1} Ã— ${factor2} = ?`;
                optionsContainer.innerHTML = '';
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = `p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform hover:scale-105 shadow-md bg-indigo-300 text-indigo-900 hover:bg-indigo-400`;
                    button.onclick = () => handleAnswer(option, button);
                    optionsContainer.appendChild(button);
                });

                scoreDisplay.textContent = score;
                questionIndex.textContent = currentQuestionIndex + 1;
                feedbackMessage.textContent = '';
                isAnimating = false;
            }

            // --- å‡½å¼ï¼šè™•ç†ç­”æ¡ˆ ---
            function handleAnswer(selectedOption, button) {
                if (isAnimating) return;
                isAnimating = true;

                const isCorrect = selectedOption === currentQuestion.answer;
                
                if (isCorrect) {
                    button.className = `p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform scale-110 shadow-lg bg-green-500 text-white`;
                    feedbackMessage.textContent = 'âœ… ç­”å°äº†ï¼';
                } else {
                    button.className = `p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform scale-105 shadow-lg bg-red-500 text-white`;
                    feedbackMessage.textContent = `âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentQuestion.answer}`;
                }

                const allButtons = optionsContainer.querySelectorAll('button');
                allButtons.forEach(btn => {
                    if (parseInt(btn.textContent) === currentQuestion.answer) {
                        btn.classList.remove('bg-indigo-300', 'hover:bg-indigo-400', 'bg-red-500', 'text-indigo-900');
                        btn.classList.add('bg-green-500', 'text-white', 'scale-110');
                    }
                    btn.disabled = true; // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
                });
                
                playSound(isCorrect);
                
                if (isCorrect) {
                    score += 10;
                }

                questionHistory.push({
                    question: `${currentQuestion.factor1} Ã— ${currentQuestion.factor2}`,
                    correctAnswer: currentQuestion.answer,
                    userAnswer: selectedOption,
                    isCorrect: isCorrect,
                });

                setTimeout(() => {
                    if (currentQuestionIndex < 9) {
                        currentQuestionIndex++;
                        generateQuestion();
                    } else {
                        showResults();
                    }
                }, 1500); // 1.5 ç§’å¾Œ
            }

            // --- å‡½å¼ï¼šé¡¯ç¤ºçµæœé é¢ ---
            function showResults() {
                questionContainer.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                finalScore.textContent = `${score} åˆ†`;
                
                playAgainBtn.textContent = selectedMultiplier === 'all'
                    ? 'å†ç©ä¸€æ¬¡ç¶œåˆç·´ç¿’ï¼ğŸ²'
                    : `å†ç©ä¸€æ¬¡ ${selectedMultiplier} çš„ä¹˜æ³•ï¼âœ¨`;

                historyTableBody.innerHTML = '';
                questionHistory.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = `border-b border-blue-50 last:border-b-0 hover:bg-blue-50 transition-colors duration-200`;
                    row.innerHTML = `
                        <td class="py-2 px-3 font-bold">${item.question}</td>
                        <td class="py-2 px-3 font-semibold ${item.isCorrect ? 'text-green-600' : 'text-red-500'}">
                            ${item.userAnswer}
                        </td>
                        <td class="py-2 px-3 font-bold text-gray-700">
                            ${item.correctAnswer}
                        </td>
                    `;
                    historyTableBody.appendChild(row);
                });
            }

            // --- å‡½å¼ï¼šé–‹å§‹æ–°ä¸€è¼ªç·´ç¿’ ---
            function startRound() {
                if (Tone.context.state !== 'running') {
                    Tone.start().then(() => {
                         _startRound();
                    });
                } else {
                     _startRound();
                }
            }
            
            function _startRound() {
                score = 0;
                currentQuestionIndex = 0;
                questionHistory = [];
                multiplierSelection.classList.add('hidden');
                resultContainer.classList.add('hidden');
                questionContainer.classList.remove('hidden');
                generateQuestion();
            }

            // --- å‡½å¼ï¼šé‡æ–°é¸æ“‡ä¹˜æ•¸ ---
            function restartPractice() {
                selectedMultiplier = null;
                multiplierSelection.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                questionContainer.classList.add('hidden');
                startBtn.disabled = true;
                startBtn.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                startBtn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');

                const allMultiplierBtns = document.querySelectorAll('#multiplierButtons button');
                allMultiplierBtns.forEach(btn => {
                    const isAllBtn = btn.dataset.multiplier === 'all';
                    if (isAllBtn) {
                        btn.className = `col-span-full p-4 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md mb-3 bg-indigo-200 text-indigo-800 hover:bg-indigo-300`;
                    } else {
                        btn.className = `p-3 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md bg-orange-200 text-orange-800 hover:bg-orange-300`;
                    }
                });
            }

            // --- äº‹ä»¶ç›£è½å™¨ ---
            learningBtn.addEventListener('click', () => showPage('learningPage'));
            practiceBtn.addEventListener('click', () => showPage('practicePage'));
            startBtn.addEventListener('click', startRound);
            restartBtn.addEventListener('click', restartPractice);
            playAgainBtn.addEventListener('click', startRound);

            multiplierButtonsContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (button && button.dataset.multiplier) {
                    selectedMultiplier = button.dataset.multiplier;
                    startBtn.disabled = false;
                    startBtn.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                    startBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');

                    const allMultiplierBtns = document.querySelectorAll('#multiplierButtons button');
                    allMultiplierBtns.forEach(btn => {
                        const isAllBtn = btn.dataset.multiplier === 'all';
                        if (btn.dataset.multiplier == selectedMultiplier) {
                            if (isAllBtn) {
                                btn.classList.remove('bg-indigo-200', 'text-indigo-800', 'hover:bg-indigo-300');
                                btn.classList.add('bg-indigo-500', 'text-white', 'ring-4', 'ring-indigo-300');
                            } else {
                                btn.classList.remove('bg-orange-200', 'text-orange-800', 'hover:bg-orange-300');
                                btn.classList.add('bg-orange-500', 'text-white', 'ring-4', 'ring-orange-300');
                            }
                        } else {
                             if (isAllBtn) {
                                btn.classList.remove('bg-indigo-500', 'text-white', 'ring-4', 'ring-indigo-300');
                                btn.classList.add('bg-indigo-200', 'text-indigo-800', 'hover:bg-indigo-300');
                            } else {
                                btn.classList.remove('bg-orange-500', 'text-white', 'ring-4', 'ring-orange-300');
                                btn.classList.add('bg-orange-200', 'text-orange-800', 'hover:bg-orange-300');
                            }
                        }
                    });

                    if (selectedMultiplier === 'all') {
                        practiceTitle.textContent = 'ç¶œåˆä¹˜æ³•ç·´ç¿’ âœ¨';
                    } else {
                        practiceTitle.textContent = `${selectedMultiplier} çš„ä¹˜æ³•ç·´ç¿’ âœ¨`;
                    }
                }
            });

            // åˆå§‹åŒ–é é¢å…§å®¹
            createMultiplicationTable();
            createMultiplierButtons();
            showPage('learningPage');
        });
    </script>
</body>
</html>
