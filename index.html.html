import React, { useState, useEffect, useRef } from 'react';
import * as Tone from 'tone'; // Import Tone.js

function App() {
  const [currentPage, setCurrentPage] = useState('learning'); // é è¨­é¡¯ç¤ºå­¸ç¿’é 

  // åˆå§‹åŒ–éŸ³è¨Šä¸Šä¸‹æ–‡çš„å‡½æ•¸
  const initializeAudioContext = async () => {
    // ç¢ºä¿éŸ³è¨Šä¸Šä¸‹æ–‡å°šæœªå•Ÿå‹•ï¼Œé¿å…é‡è¤‡å•Ÿå‹•
    if (Tone.context.state !== 'running') {
      await Tone.start();
      console.log('AudioContext is initialized and running!'); // ç¢ºèªè¨Šæ¯
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-100 to-blue-100 flex flex-col items-center justify-center p-4 font-inter">
      {/* å°è¦½åˆ— */}
      <nav className="mb-8 p-4 bg-white rounded-2xl shadow-lg flex flex-wrap justify-center gap-4">
        <button
          onClick={() => {
            initializeAudioContext(); // åœ¨é»æ“Šå°è¦½æŒ‰éˆ•æ™‚åˆå§‹åŒ–éŸ³è¨Š
            setCurrentPage('learning');
          }}
          className={`px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105
            ${currentPage === 'learning' ? 'bg-purple-500 text-white shadow-md' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'}`}
        >
          ğŸ“š å­¸ç¿’ä¹˜æ³•
        </button>
        <button
          onClick={() => {
            initializeAudioContext(); // åœ¨é»æ“Šå°è¦½æŒ‰éˆ•æ™‚åˆå§‹åŒ–éŸ³è¨Š
            setCurrentPage('practice');
          }}
          className={`px-6 py-3 rounded-full text-lg font-bold transition-all duration-300 transform hover:scale-105
            ${currentPage === 'practice' ? 'bg-green-500 text-white shadow-md' : 'bg-green-200 text-green-800 hover:bg-green-300'}`}
        >
          ğŸ“ ç·´ç¿’æŒ‘æˆ°
        </button>
      </nav>

      {/* æ ¹æ“š currentPage é¡¯ç¤ºä¸åŒé é¢ */}
      <main className="w-full max-w-4xl bg-white rounded-3xl shadow-xl p-6 md:p-8 transform transition-transform duration-500 ease-out">
        {currentPage === 'learning' ? <LearningPage /> : <PracticePage />}
      </main>
    </div>
  );
}

function LearningPage() {
  const [hoveredRow, setHoveredRow] = useState(null); // è¿½è¹¤æ»‘é¼ æ‰€åœ¨çš„è¡Œ
  const [hoveredCol, setHoveredCol] = useState(null); // è¿½è¹¤æ»‘é¼ æ‰€åœ¨çš„åˆ—

  // è™•ç†æ»‘é¼ é€²å…¥å„²å­˜æ ¼
  const handleCellEnter = (row, col) => {
    setHoveredRow(row);
    setHoveredCol(col);
  };

  // è™•ç†æ»‘é¼ é›¢é–‹å„²å­˜æ ¼
  const handleCellLeave = () => {
    setHoveredRow(null);
    setHoveredCol(null);
  };

  return (
    <div className="text-center">
      <h1 className="text-4xl md:text-5xl font-extrabold text-blue-600 mb-8 drop-shadow-md">
        ååä¹˜æ³•è¡¨ ğŸ’–
      </h1>
      <div className="overflow-x-auto">
        <table className="min-w-full bg-blue-50 border border-blue-200 rounded-xl shadow-lg">
          <thead>
            <tr className="bg-blue-200 text-blue-800">
              <th className="py-3 px-2 md:px-4 border-b border-blue-200 text-lg md:text-xl font-bold rounded-tl-xl">Ã—</th>
              {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
                <th
                  key={num}
                  className={`py-3 px-2 md:px-4 border-b border-blue-200 text-lg md:text-xl font-bold
                    ${hoveredCol === num ? 'bg-yellow-300' : ''}`} // æ¨™é¡Œåˆ—çš„é¡è‰²åæ‡‰
                >
                  {num}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {Array.from({ length: 10 }, (_, i) => i + 1).map((rowNum) => (
              <tr key={rowNum} className="transition-colors duration-200">
                <td
                  className={`py-3 px-2 md:px-4 border-b border-blue-200 text-blue-700 font-bold bg-blue-100 rounded-bl-xl text-lg md:text-xl
                    ${hoveredRow === rowNum ? 'bg-yellow-300' : ''}`} // æ¨™é¡Œè¡Œçš„é¡è‰²åæ‡‰
                >
                  {rowNum}
                </td>
                {Array.from({ length: 10 }, (_, i) => i + 1).map((colNum) => (
                  <td
                    key={`${rowNum}-${colNum}`}
                    onMouseEnter={() => handleCellEnter(rowNum, colNum)}
                    onMouseLeave={handleCellLeave}
                    className={`py-3 px-2 md:px-4 border-b border-blue-200 text-gray-700 text-lg md:text-xl
                      ${(hoveredRow === rowNum || hoveredCol === colNum) ? 'bg-yellow-100' : ''}`} // å„²å­˜æ ¼æœ¬èº«çš„é¡è‰²åæ‡‰
                  >
                    {rowNum * colNum}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <p className="mt-8 text-gray-600 text-lg">
        é€™å€‹è¡¨æ ¼å¯ä»¥å¹«åŠ©ä½ å¿«é€Ÿå­¸ç¿’ä¹˜æ³•ï¼
      </p>
    </div>
  );
}

function PracticePage() {
  const [selectedMultiplier, setSelectedMultiplier] = useState(null); // é¸æ“‡çš„ä¹˜æ•¸ï¼Œå¯ä»¥æ˜¯æ•¸å­—æˆ– 'all'
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); // ç•¶å‰é¡Œç›®ç´¢å¼• (0-9)
  const [currentQuestion, setCurrentQuestion] = useState(null); // ç•¶å‰é¡Œç›® { factor1, factor2, answer }
  const [options, setOptions] = useState([]); // ç­”æ¡ˆé¸é …
  const [score, setScore] = useState(0); // åˆ†æ•¸
  const [roundStarted, setRoundStarted] = useState(false); // å›åˆæ˜¯å¦é–‹å§‹
  const [feedbackMessage, setFeedbackMessage] = useState(''); // å›é¥‹è¨Šæ¯
  const [showResult, setShowResult] = useState(false); // é¡¯ç¤ºçµæœé é¢
  const [selectedAnswer, setSelectedAnswer] = useState(null); // ç”¨æˆ¶é¸æ“‡çš„ç­”æ¡ˆ
  const [isCorrectAnswer, setIsCorrectAnswer] = useState(null); // ç”¨æ–¼ç­”æ¡ˆæŒ‰éˆ•çš„è¦–è¦ºå›é¥‹
  const [questionHistory, setQuestionHistory] = useState([]); // æ–°å¢ï¼šå„²å­˜æ‰€æœ‰é¡Œç›®æ­·å²

  // Tone.js éŸ³æ•ˆåˆæˆå™¨
  const synthRef = useRef(null);

  useEffect(() => {
    // åˆå§‹åŒ– Tone.js åˆæˆå™¨
    synthRef.current = new Tone.Synth().toDestination();
    // é€™è£¡ä¸å†å‘¼å« Tone.start()ï¼Œå› ç‚ºå®ƒæœƒåœ¨å°è¦½æŒ‰éˆ•é»æ“Šæ™‚å•Ÿå‹•
    return () => {
      // åœ¨çµ„ä»¶å¸è¼‰æ™‚é‡‹æ”¾éŸ³æ•ˆè³‡æº
      if (synthRef.current) {
        synthRef.current.dispose();
      }
    };
  }, []);

  // å¹«åŠ©å‡½å¼ï¼šå»¶é²ä¸€æ®µæ™‚é–“
  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ (å®å’šå®å’š)
  const playCorrectSound = async () => {
    if (synthRef.current && Tone.context.state === 'running') { // ç¢ºä¿éŸ³è¨Šä¸Šä¸‹æ–‡å·²å•Ÿå‹•
      synthRef.current.triggerAttackRelease("C5", "8n"); // ç¬¬ä¸€å€‹å®
      await delay(100); // 0.1ç§’é–“éš”
      synthRef.current.triggerAttackRelease("G5", "8n"); // ç¬¬ä¸€å€‹å’š
      await delay(200); // 0.2ç§’é–“éš” (å…©çµ„å®å’šä¹‹é–“)
      synthRef.current.triggerAttackRelease("C5", "8n"); // ç¬¬äºŒå€‹å®
      await delay(100); // 0.1ç§’é–“éš”
      synthRef.current.triggerAttackRelease("G5", "8n"); // ç¬¬äºŒå€‹å’š
    }
  };

  // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ (å™ å™ )
  const playIncorrectSound = async () => {
    if (synthRef.current && Tone.context.state === 'running') { // ç¢ºä¿éŸ³è¨Šä¸Šä¸‹æ–‡å·²å•Ÿå‹•
      synthRef.current.triggerAttackRelease("F4", "8n");
      await delay(250); // æ¨¡æ“¬8nçš„å»¶é²
      synthRef.current.triggerAttackRelease("C4", "8n");
    }
  };

  // ç”Ÿæˆæ–°çš„å•é¡Œå’Œé¸é …
  const generateQuestion = (multiplier) => {
    let factor1, factor2;

    if (multiplier === 'all') {
      // ç¶œåˆç·´ç¿’ï¼Œå…©å€‹ä¹˜æ•¸éƒ½æ˜¯éš¨æ©Ÿ 1 åˆ° 10
      factor1 = Math.floor(Math.random() * 10) + 1;
      factor2 = Math.floor(Math.random() * 10) + 1;
    } else {
      // ç‰¹å®šä¹˜æ•¸ç·´ç¿’
      factor1 = multiplier;
      factor2 = Math.floor(Math.random() * 10) + 1; // 1 åˆ° 10
    }

    const answer = factor1 * factor2;

    const newOptions = new Set();
    newOptions.add(answer); // æ·»åŠ æ­£ç¢ºç­”æ¡ˆ

    // ç”Ÿæˆä¸‰å€‹éŒ¯èª¤é¸é …
    while (newOptions.size < 4) {
      let wrongAnswer = answer + (Math.floor(Math.random() * 20) - 10); // åœ¨ç­”æ¡ˆé™„è¿‘ç”Ÿæˆ
      // ç¢ºä¿ç­”æ¡ˆä¸ç‚ºè² æˆ–é›¶ï¼Œä¸”èˆ‡æ­£ç¢ºç­”æ¡ˆä¸åŒ
      if (wrongAnswer <= 0 || wrongAnswer === answer) {
        continue;
      }
      newOptions.add(wrongAnswer);
    }

    const shuffledOptions = Array.from(newOptions).sort(() => Math.random() - 0.5);

    setCurrentQuestion({ factor1: factor1, factor2: factor2, answer: answer });
    setOptions(shuffledOptions);
    setSelectedAnswer(null); // é‡ç½®é¸æ“‡çš„ç­”æ¡ˆ
    setIsCorrectAnswer(null); // é‡ç½®ç­”æ¡ˆå›é¥‹
    setFeedbackMessage(''); // æ¸…ç©ºå›é¥‹è¨Šæ¯
  };

  // è™•ç†ç”¨æˆ¶é¸æ“‡ç­”æ¡ˆ
  const handleAnswer = (selectedOption) => {
    if (selectedAnswer !== null) return; // é¿å…é‡è¤‡é»æ“Š

    setSelectedAnswer(selectedOption); // è¨­ç½®ç”¨æˆ¶é¸æ“‡çš„ç­”æ¡ˆ
    const correct = selectedOption === currentQuestion.answer;
    setIsCorrectAnswer(correct); // è¨­ç½®æ­£ç¢ºæ€§å›é¥‹

    if (correct) {
      setScore((prevScore) => prevScore + 10);
      setFeedbackMessage('âœ… ç­”å°äº†ï¼');
      playCorrectSound();
    } else {
      setFeedbackMessage(`âŒ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentQuestion.answer}`);
      playIncorrectSound();
    }

    // å„²å­˜ç•¶å‰é¡Œç›®çš„æ­·å²è¨˜éŒ„
    setQuestionHistory((prevHistory) => [
      ...prevHistory,
      {
        question: `${currentQuestion.factor1} Ã— ${currentQuestion.factor2}`,
        correctAnswer: currentQuestion.answer,
        userAnswer: selectedOption,
        isCorrect: correct,
      },
    ]);

    // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œé€²å…¥ä¸‹ä¸€é¡Œæˆ–é¡¯ç¤ºçµæœ
    setTimeout(() => {
      if (currentQuestionIndex < 9) {
        setCurrentQuestionIndex((prevIndex) => prevIndex + 1);
        generateQuestion(selectedMultiplier);
      } else {
        setShowResult(true);
      }
    }, 1500); // 1.5 ç§’å¾Œ
  };

  // é–‹å§‹ä¸€è¼ªç·´ç¿’
  const startRound = () => {
    setScore(0);
    setCurrentQuestionIndex(0);
    setRoundStarted(true);
    setShowResult(false);
    setQuestionHistory([]); // é‡ç½®é¡Œç›®æ­·å²
    generateQuestion(selectedMultiplier);
  };

  // é‡æ–°é–‹å§‹ç·´ç¿’
  const restartPractice = () => {
    setSelectedMultiplier(null);
    setRoundStarted(false);
    setShowResult(false);
    setFeedbackMessage('');
    setQuestionHistory([]); // é‡ç½®é¡Œç›®æ­·å²
  };

  // æ¸²æŸ“é¸æ“‡ä¹˜æ•¸çš„ä»‹é¢
  if (!roundStarted) {
    return (
      <div className="text-center p-4">
        <h1 className="text-4xl md:text-5xl font-extrabold text-green-600 mb-8 drop-shadow-md">
          ä¹˜æ³•å¤§æŒ‘æˆ° ğŸŒŸ
        </h1>
        <p className="text-xl text-gray-700 mb-6">
          é€²å…¥ã€ç¶œåˆç·´ç¿’ã€‘é€²è¡ŒæŒ‘æˆ°ï¼Œæˆ–é¸æ“‡ä½ æƒ³ç·´ç¿’çš„æ•¸å­—æ®µå“¦ï¼
        </p>
        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 max-w-2xl mx-auto mb-8">
          {/* ç¶œåˆç·´ç¿’æŒ‰éˆ•ç§»åˆ°æœ€å‰é¢ä¸¦ç½®ä¸­ */}
          <button
            onClick={() => setSelectedMultiplier('all')}
            className={`col-span-full p-4 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md mb-4
              ${selectedMultiplier === 'all' ? 'bg-indigo-500 text-white ring-4 ring-indigo-300' : 'bg-indigo-200 text-indigo-800 hover:bg-indigo-300'}`}
          >
            ğŸ² ç¶œåˆç·´ç¿’ (1~10)
          </button>
          {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
            <button
              key={num}
              onClick={() => setSelectedMultiplier(num)}
              className={`p-4 rounded-xl text-2xl font-bold transition-all duration-300 transform hover:scale-110 shadow-md
                ${selectedMultiplier === num ? 'bg-orange-500 text-white ring-4 ring-orange-300' : 'bg-orange-200 text-orange-800 hover:bg-orange-300'}`}
            >
              {num}
            </button>
          ))}
        </div>
        <button
          onClick={startRound}
          disabled={selectedMultiplier === null}
          className={`px-8 py-4 rounded-full text-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg
            ${selectedMultiplier === null ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`}
        >
          é–‹å§‹ç·´ç¿’ï¼ğŸš€
        </button>
      </div>
    );
  }

  // æ¸²æŸ“ç·´ç¿’ä»‹é¢
  if (roundStarted && !showResult) {
    // æ ¹æ“šé¸æ“‡çš„ä¹˜æ•¸é¡¯ç¤ºä¸åŒçš„æ¨™é¡Œ
    const practiceTitle = selectedMultiplier === 'all'
      ? 'ç¶œåˆä¹˜æ³•ç·´ç¿’ âœ¨'
      : `ä¹˜æ³•ç·´ç¿’ï¼š${selectedMultiplier} çš„ä¹˜æ³•è¡¨ âœ¨`;

    return (
      <div className="text-center p-4">
        <h1 className="text-4xl md:text-5xl font-extrabold text-purple-600 mb-6 drop-shadow-md">
          {practiceTitle}
        </h1>
        <div className="text-2xl md:text-3xl font-bold text-gray-700 mb-4">
          å¾—åˆ†: <span className="text-green-600">{score}</span> / 100
        </div>
        <div className="text-xl md:text-2xl text-gray-600 mb-8">
          é¡Œç›® {currentQuestionIndex + 1} / 10
        </div>

        {currentQuestion && (
          <div className="bg-yellow-100 p-6 rounded-3xl shadow-xl inline-block mb-8 transition-transform duration-300 transform scale-105">
            <p className="text-5xl md:text-6xl font-extrabold text-yellow-800">
              {currentQuestion.factor1} Ã— {currentQuestion.factor2} = ?
            </p>
          </div>
        )}

        <div className="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
          {options.map((option) => (
            <button
              key={option}
              onClick={() => handleAnswer(option)}
              disabled={selectedAnswer !== null} // ç¦ç”¨æŒ‰éˆ•ç›´åˆ°ä¸‹ä¸€é¡Œ
              className={`p-4 rounded-2xl text-3xl font-bold transition-all duration-300 transform hover:scale-105 shadow-md
                ${selectedAnswer === null
                  ? 'bg-indigo-300 text-indigo-900 hover:bg-indigo-400' // æœªé¸æ“‡æ™‚
                  : option === currentQuestion.answer
                    ? 'bg-green-500 text-white scale-110 shadow-lg' // æ­£ç¢ºç­”æ¡ˆ
                    : (selectedAnswer === option && !isCorrectAnswer)
                      ? 'bg-red-500 text-white scale-105 shadow-lg' // éŒ¯èª¤ç­”æ¡ˆ
                      : 'bg-indigo-300 text-indigo-900 opacity-50 cursor-not-allowed' // å…¶ä»–æœªé¸æ“‡çš„ç­”æ¡ˆ
                }`}
            >
              {option}
            </button>
          ))}
        </div>

        {feedbackMessage && (
          <p className="text-2xl md:text-3xl font-bold mt-4 animate-bounce">
            {feedbackMessage}
          </p>
        )}
      </div>
    );
  }

  // æ¸²æŸ“çµæœé é¢
  if (showResult) {
    return (
      <div className="text-center p-4">
        <h1 className="text-4xl md:text-5xl font-extrabold text-teal-600 mb-8 drop-shadow-md">
          ç·´ç¿’çµæŸï¼ğŸ‰
        </h1>
        <p className="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
          ä½ çš„æœ€çµ‚å¾—åˆ†æ˜¯ï¼š
        </p>
        <p className="text-5xl md:text-6xl font-extrabold text-teal-600 bg-teal-50 p-6 rounded-full inline-block shadow-lg animate-bounce">
          {score} åˆ†
        </p>

        {/* æ–°å¢ï¼šé¡¯ç¤ºé¡Œç›®å’Œç­”æ¡ˆå›é¡§ */}
        <h2 className="text-3xl font-bold text-blue-600 mt-10 mb-6 drop-shadow-md">
          é¡Œç›®å›é¡§
        </h2>
        <div className="bg-white rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto mx-auto max-w-xl">
          <table className="min-w-full text-left text-lg">
            <thead>
              <tr className="bg-blue-100 text-blue-800">
                <th className="py-2 px-3 border-b border-blue-200">é¡Œç›®</th>
                <th className="py-2 px-3 border-b border-blue-200">ä½ çš„ç­”æ¡ˆ</th>
                <th className="py-2 px-3 border-b border-blue-200">æ­£ç¢ºç­”æ¡ˆ</th>
              </tr>
            </thead>
            <tbody>
              {questionHistory.map((item, index) => (
                <tr key={index} className="border-b border-blue-50 last:border-b-0 hover:bg-blue-50 transition-colors duration-200">
                  <td className="py-2 px-3 font-bold">{item.question}</td> {/* é¡Œç›®åŠ ç²— */}
                  <td className={`py-2 px-3 font-semibold ${item.isCorrect ? 'text-green-600' : 'text-red-500'}`}>
                    {item.userAnswer}
                  </td>
                  <td className="py-2 px-3 font-bold text-gray-700"> {/* æ­£ç¢ºç­”æ¡ˆåŠ ç²— */}
                    {item.correctAnswer}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div className="mt-8 flex flex-col md:flex-row justify-center gap-4">
          <button
            onClick={restartPractice}
            className="px-8 py-4 rounded-full text-2xl font-bold bg-orange-500 text-white hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            é‡æ–°é¸æ“‡ç·´ç¿’ ğŸ”„
          </button>
          <button
            onClick={startRound}
            className="px-8 py-4 rounded-full text-2xl font-bold bg-purple-500 text-white hover:bg-purple-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
          >
            {selectedMultiplier === 'all' ? 'å†ç©ä¸€æ¬¡ç¶œåˆç·´ç¿’ï¼ğŸ²' : `å†ç©ä¸€æ¬¡ ${selectedMultiplier} çš„ä¹˜æ³•ï¼âœ¨`}
          </button>
        </div>
      </div>
    );
  }
}

export default App;
